name: Test

on:
  pull_request:    
    types: [reopened]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        # 2. SETUP NODE
      - name: 2. SETUP NODE
        uses: actions/setup-node@v3
        with:
          node-version: '>=20'
          check-latest: true
      - name: 5. Install Resolution Automation Dependencies
        run: |
          node --version
          npm i dotenv --legacy-peer-deps
          npm i xml-js --legacy-peer-deps
          npm i minimist --legacy-peer-deps
          npm i html-to-json-parser --legacy-peer-deps
    # 6. GET SCRIPT FILE
      - name: 6. GET SCRIPT FILE
        run: |
          mkdir ResolutionScript && cd ResolutionScript
          wget https://github.com/MarcusVB12/AzureVisum/blob/be4368de387998ac423e511d47732070ce965921/.github/actions/send-message-action/index.js
      # - name: 5. Install Resolution Automation Dependencies
      #   run: |
      #     node --version
      #     npm i dotenv --legacy-peer-deps
      #     npm i xml-js --legacy-peer-deps
      #     npm i minimist --legacy-peer-deps
      #     npm i html-to-json-parser --legacy-peer-deps
      # - name: chamando o js
      #   uses: ./.github/actions/send-message-action
      # 7. UPDATE DEVOPS RESOLUTION
      # - name: 7. UPDATE DEVOPS RESOLUTION (${{ github.head_ref }})
      #   run: |
      #     echo $(node src/action.js)
            - name: Get Merged Branches
        run: |
          git fetch --unshallow || true  # Garante que o repositório tenha histórico completo
          git fetch --prune              # Atualiza todas as referências remotas

          touch merged_branches_list.txt  # Garante que o arquivo exista

          # Verificar qual é a branch principal corretamente
          if git ls-remote --exit-code origin main; then
            MAIN_BRANCH="origin/main"
          elif git ls-remote --exit-code origin master; then
            MAIN_BRANCH="origin/master"
          else
            echo "Erro: Nenhuma branch principal encontrada no remoto!" && exit 1
          fi

          # Checkout na branch principal
          git checkout --track $MAIN_BRANCH || git checkout -b main $MAIN_BRANCH
          git pull --all

          # Lista todas as branches mergeadas corretamente
          git branch --merged main | grep -v "main" | while read branch; do
            if [ -n "$branch" ]; then
              echo "$branch - $(git log -1 --pretty=format:'%an' $branch)" >> merged_branches_list.txt
            fi
          done

          cat merged_branches_list.txt  # Exibe a lista no console


      - name: Upload Merged Branches List
        uses: actions/upload-artifact@v4
        with:
          name: merged-branches-list
          path: merged_branches_list.txt



      